#!/usr/bin/env bash
set -e

echo "ðŸš€ Starting project setup..."

# ðŸ™ Step 1: Init submodule if it hasn't been cloned yet
if [ ! -f "hyrax-webapp/.git" ]; then
  echo "ðŸ“¦ Initializing hyrax-webapp submodule..."
  git submodule update --init --recursive
else
  echo "ðŸ“¦ hyrax-webapp already checked out â€” skipping submodule update"
fi

# ðŸ³ Step 2: Make sure Docker is running
if ! docker info >/dev/null 2>&1; then
  echo "âŒ Docker is not running. Please start Docker Desktop or your Docker daemon."
  exit 1
fi

# ðŸ§  Step 3: Set BASE_IMAGE from the submodule SHA
echo "ðŸ”§ Setting BASE_IMAGE in .env..."
SUBMODULE_SHA=$(cd hyrax-webapp && git rev-parse --short=8 HEAD)
BASE_IMAGE="ghcr.io/samvera/hyku/base:$SUBMODULE_SHA"

# Create or update .env file
if grep -q '^BASE_IMAGE=' .env 2>/dev/null; then
  sed -i.bak "s|^BASE_IMAGE=.*|BASE_IMAGE=$BASE_IMAGE|" .env && rm .env.bak
else
  echo "BASE_IMAGE=$BASE_IMAGE" >> .env
fi
echo "âœ… BASE_IMAGE set to $BASE_IMAGE"

# ðŸª Step 4: Install a post-checkout git hook to auto-update .env if submodule changes
HOOK_PATH=".git/hooks/post-checkout"
if [ ! -f "$HOOK_PATH" ]; then
  echo "ðŸª Installing post-checkout git hook..."
  cat > "$HOOK_PATH" <<EOF
#!/usr/bin/env bash
if git diff --name-only HEAD@{1} HEAD | grep -q "^hyrax-webapp"; then
  echo "ðŸŒ€ hyrax-webapp submodule changed â€” re-running setup to update BASE_IMAGE..."
  ./bin/setup
fi
EOF
  chmod +x "$HOOK_PATH"
  echo "âœ… post-checkout hook installed"
else
  echo "â„¹ï¸ Git hook already installed at $HOOK_PATH"
fi

echo "ðŸŽ‰ Setup complete! You can now run:"
echo ""
echo "  docker compose build"
echo "  docker compose up"
echo ""
